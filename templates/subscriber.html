<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Agent Dashboard</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="/static/css/styles.css">
    <link rel="stylesheet" href="/static/css/pages/agent_dashboard.css">
    <script src="https://cdn.signalwire.com/@signalwire/js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css">
</head>
<body>
    <!-- Topbar -->
    <header class="topbar d-flex align-items-center justify-content-between px-4">
      <div class="d-flex align-items-center">
        <span class="sw-logo"></span>
        <div class="agent-avatar">{{ (display_name or first_name or 'U')[0] }}</div>        <div>
        <div class="fw-bold" id="dashboardUserName">{{ display_name }}</div>
        </div>
      </div>
      <div class="d-flex align-items-center">
        <div id="agentStatus" class="agent-status">
          <span id="statusDot" class="status-dot status-offline"></span>
          <span id="statusText">Offline</span>
        </div>
        <div class="topbar-actions ms-4 dropdown">
          <a href="#" class="dropdown-toggle" id="settingsDropdown" data-bs-toggle="dropdown" aria-expanded="false" title="Settings">
            <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" fill="currentColor" class="bi bi-gear" viewBox="0 0 16 16"><path d="M8 4.754a3.246 3.246 0 1 0 0 6.492 3.246 3.246 0 0 0 0-6.492zM5.754 8a2.246 2.246 0 1 1 4.492 0 2.246 2.246 0 0 1-4.492 0z"/><path d="M9.796 1.343c-.527-1.79-3.065-1.79-3.592 0l-.094.319a.873.873 0 0 1-1.255.52l-.292-.16c-1.64-.892-3.433.902-2.54 2.541l.159.292a.873.873 0 0 1-.52 1.255l-.319.094c-1.79.527-1.79 3.065 0 3.592l.319.094a.873.873 0 0 1 .52 1.255l-.16.292c-.892 1.64.901 3.434 2.541 2.54l.292-.159a.873.873 0 0 1 1.255.52l.094.319c.527 1.79 3.065 1.79 3.592 0l.094-.319a.873.873 0 0 1 1.255-.52l.292.16c1.64.893 3.434-.902 2.54-2.541l-.159-.292a.873.873 0 0 1 .52-1.255l.319-.094c1.79-.527 1.79-3.065 0-3.592l-.319-.094a.873.873 0 0 1-.52-1.255l.16-.292c.893-1.64-.902-3.433-2.541-2.54l-.292.159a.873.873 0 0 1-1.255-.52l-.094-.319zm-2.633.283c.246-.835 1.428-.835 1.674 0l.094.319a1.873 1.873 0 0 0 2.693 1.115l.291-.16c.764-.415 1.6.42 1.184 1.185l-.159.292a1.873 1.873 0 0 0 1.116 2.692l.318.094c.835.246.835 1.428 0 1.674l-.319.094a1.873 1.873 0 0 0-1.115 2.693l.16.291c.415.764-.42 1.6-1.185 1.184l-.291-.159a1.873 1.873 0 0 0-2.693 1.116l-.094.318c-.246.835-1.428.835-1.674 0l-.094-.319a1.873 1.873 0 0 0-2.692-1.115l-.292.16c-.764.415-1.6-.42-1.184-1.185l.159-.291A1.873 1.873 0 0 0 1.945 8.93l-.319-.094c-.835-.246-.835-1.428 0-1.674l.319-.094A1.873 1.873 0 0 0 3.38 4.377l-.16-.292c-.415-.764.42-1.6 1.185-1.184l.292.159a1.873 1.873 0 0 0 2.692-1.115l.094-.319z"/></svg>
          </a>
          <ul class="dropdown-menu" aria-labelledby="settingsDropdown">
            <li><a class="dropdown-item" href="#" id="showSubscriberInfo">Subscriber Info</a></li>
            <li><hr class="dropdown-divider"></li>
            <li><a class="dropdown-item" href="/logout">Logout</a></li>
          </ul>
        </div>
      </div>
    </header>
    <div class="container">
      <div class="row justify-content-center">
        <div class="col-lg-8">
          <div class="dashboard-card main-controls">
            <div class="d-flex flex-column align-items-center mb-3">
              <div id="callStatus" class="mb-2">Waiting for call...</div>
            </div>
            <div id="callInfo" class="mb-3"></div>
            <div class="call-controls">
              <button id="goOnlineBtn" class="demo-button">Go Online</button>
              <button id="goOfflineBtn" class="demo-button hidden">Go Offline</button>
              <button id="hangupCallBtn" class="demo-button hidden">
                <i class="bi bi-telephone-x-fill" style="font-size:1.3em; margin-right:0.5em;"></i>Hangup
              </button>
            </div>
          </div>
        </div>
      </div>
    </div>
    <input id="host" type="hidden" value="devspace.signalwire.com" />
    <input id="token" type="hidden" value="" readonly />
    <!-- Subscriber Info Modal -->
    <div class="modal fade" id="subscriberInfoModal" tabindex="-1" aria-labelledby="subscriberInfoModalLabel" aria-hidden="true">
      <div class="modal-dialog">
        <div class="modal-content bg-dark text-white border-0">
          <div class="modal-header border-0" style="background:rgba(12,19,57,0.95);">
            <h5 class="modal-title" id="subscriberInfoModalLabel">Subscriber Info</h5>
            <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
          </div>
          <div class="modal-body" style="background:rgba(12,19,57,0.85);">
            <table class="table table-dark table-borderless mb-0" id="subscriberInfoTable">
              <tr><th>Email:</th><td data-field="email"></td></tr>
              <tr><th>First Name:</th><td data-field="first_name"></td></tr>
              <tr><th>Last Name:</th><td data-field="last_name"></td></tr>
              <tr><th>Display Name:</th><td data-field="display_name"></td></tr>
              <tr><th>Job Title:</th><td data-field="job_title"></td></tr>
              <tr><th>Timezone:</th><td data-field="time_zone"></td></tr>
              <tr><th>Country:</th><td data-field="country"></td></tr>
              <tr><th>Region:</th><td data-field="region"></td></tr>
              <tr><th>Company Name:</th><td data-field="company_name"></td></tr>
              <tr><th>Subscriber ID:</th><td data-field="id"></td></tr>
            </table>
          </div>
          <div class="modal-footer border-0" style="background:rgba(12,19,57,0.95);">
            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
          </div>
        </div>
      </div>
    </div>
    <!-- Incoming Call Modal -->
    <div class="modal fade" id="incomingCallModal" tabindex="-1" aria-labelledby="incomingCallModalLabel" aria-hidden="true">
      <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content bg-dark text-white border-0" style="box-shadow: 0 8px 32px rgba(0,0,0,0.35);">
          <div class="modal-header border-0" style="background:rgba(12,19,57,0.95);">
            <h5 class="modal-title" id="incomingCallModalLabel">
              <i class="bi bi-telephone-inbound me-2" style="font-size: 1.5em;"></i>
              Incoming Call
            </h5>
            <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
          </div>
          <div class="modal-body text-center" style="background:rgba(12,19,57,0.85);">
            <div id="incomingCallerName" class="fs-4 fw-bold mb-2"></div>
            <div id="incomingCallerSummary" class="mb-3 text-secondary"></div>
            <div class="d-flex justify-content-center gap-4 mt-4">
              <button id="modalAcceptCallBtn" class="btn btn-success btn-lg rounded-circle d-flex align-items-center justify-content-center" style="width:64px;height:64px;">
                <i class="bi bi-telephone" style="font-size:2em;"></i>
              </button>
              <button id="modalRejectCallBtn" class="btn btn-danger btn-lg rounded-circle d-flex align-items-center justify-content-center" style="width:64px;height:64px;">
                <i class="bi bi-telephone-x" style="font-size:2em;"></i>
              </button>
            </div>
          </div>
        </div>
      </div>
    </div>
    <script>
      let client = null;
      let clientListenersAttached = false;
      let invite = null;
      let call = null;
      let currentCallId = null;
      let cachedCallInfo = null;
      let subscriberInfo = null;
      let callAccepted = false;

      const callStatus = document.getElementById('callStatus');
      const hangupCallBtn = document.getElementById('hangupCallBtn');
      const callInfoDiv = document.getElementById('callInfo');
      const goOnlineBtn = document.getElementById('goOnlineBtn');
      const goOfflineBtn = document.getElementById('goOfflineBtn');
      const tokenInput = document.getElementById('token');
      const modalAcceptCallBtn = document.getElementById('modalAcceptCallBtn');
      const modalRejectCallBtn = document.getElementById('modalRejectCallBtn');

      // Helper: Update subscriber info in UI
      function updateSubscriberUI(info) {
        document.querySelector('.agent-avatar').textContent =
          (info.first_name && info.first_name[0]) || (info.email && info.email[0]) || 'SW';
        const table = document.getElementById('subscriberInfoTable');
        if (table) {
          ["email","first_name","last_name","display_name","job_title","time_zone","country","region","company_name","id"].forEach(field => {
            table.querySelector(`[data-field="${field}"]`).textContent = info[field] || '';
          });
        }
      }

      // Helper: Show/hide modal using Bootstrap API
      function showModal(id) {
        var modal = bootstrap.Modal.getOrCreateInstance(document.getElementById(id));
        modal.show();
      }
      function hideModal(id) {
        var modal = bootstrap.Modal.getOrCreateInstance(document.getElementById(id));
        modal.hide();
      }

      // Helper: Format caller info for modal/dashboard
      function formatCallerInfo(data, labelName = 'Name', labelSummary = 'Summary') {
        let html = '';
        if (data && (data.first_name || data.last_name || data.summary)) {
          if (data.first_name || data.last_name) {
            html += `<b>${labelName}:</b> ${[data.first_name, data.last_name].filter(Boolean).join(' ')}<br>`;
          }
          if (data.summary) {
            html += `<b>${labelSummary}:</b> ${data.summary}`;
          }
        } else {
          html = '<i>No info provided.</i>';
        }
        return html;
      }

      // Helper: Set call info in both modal and dashboard
      function applyCallInfoToUI(data) {
        document.getElementById('incomingCallerSummary').innerHTML = formatCallerInfo(data, 'Name', 'Summary');
        const callInfoArea = document.getElementById('callInfo');
        callInfoArea.innerHTML = formatCallerInfo(data, 'Caller', 'Summary');
        if (callAccepted) {
          callInfoArea.classList.remove('hidden');
        } else {
          callInfoArea.classList.add('hidden');
        }
      }

      // Helper: Set dashboard status dot, text, and call status text
      function setDashboardStatus(state) {
        const dot = document.getElementById('statusDot');
        const text = document.getElementById('statusText');
        switch (state) {
          case 'connecting':
            dot.className = 'status-dot status-connecting';
            text.textContent = 'Connecting';
            callStatus.textContent = 'Connecting...';
            break;
          case 'online':
            dot.className = 'status-dot status-online';
            text.textContent = 'Online';
            callStatus.textContent = 'Waiting for call...';
            break;
          case 'incoming':
            dot.className = 'status-dot status-online';
            text.textContent = 'Online';
            callStatus.textContent = 'Incoming call...';
            break;
          case 'in-call':
            dot.className = 'status-dot status-in-call';
            text.textContent = 'In Call';
            callStatus.textContent = 'In call!';
            break;
          case 'offline':
            dot.className = 'status-dot status-offline';
            text.textContent = 'Offline';
            callStatus.textContent = 'Offline. Not receiving calls.';
            break;
          case 'failed':
            dot.className = 'status-dot status-offline';
            text.textContent = 'Offline';
            callStatus.textContent = 'Failed to connect.';
            break;
          default:
            dot.className = 'status-dot status-offline';
            text.textContent = 'Offline';
            callStatus.textContent = '';
        }
      }

      // Helper: Clear call info in dashboard
      function clearCallInfo() {
        const callInfoArea = document.getElementById('callInfo');
        callInfoArea.innerHTML = '';
        callInfoArea.classList.add('hidden');
      }

      // Fetch token and instantiate client on page load
      async function createClientAndAttachListeners(host, token) {
        client = await SignalWire.SignalWire({ host, token, debug: { logWsTraffic: false } });
        window.__client = client;
        if (!clientListenersAttached) {
          client.on('call.state', (params) => {
            if (params.call_state === 'created' && params.parent && params.parent.call_id) {
              fetch(`/api/call_info/${params.parent.call_id}`)
                .then(resp => resp.ok ? resp.json() : null)
                .then(data => {
                  cachedCallInfo = data;
                  applyCallInfoToUI(data);
                })
                .catch(() => {
                  cachedCallInfo = null;
                  applyCallInfoToUI(null);
                });
            }
            // Hide modal if call ended
            if (params.call_state === 'ended') {
              hideModal('incomingCallModal');
            }
          });
          clientListenersAttached = true;
        }
        subscriberInfo = await client.getSubscriberInfo();
        updateSubscriberUI(subscriberInfo);
      }

      // Helper: Reset UI after call ends
      function resetAfterCallEnd() {
        hangupCallBtn.classList.add('hidden');
        callAccepted = false;
        clearCallInfo();
        setDashboardStatus('online');
      }

      goOnlineBtn.onclick = async () => {
        setDashboardStatus('connecting');
        goOnlineBtn.disabled = true;
        goOnlineBtn.classList.add('hidden');
        let token = document.getElementById('token').value;
        const host = document.getElementById('host').value;
        let triedNewToken = false;
        let onlineSuccess = false;
        async function tryOnlineWithRetry(retries = 3, delay = 1500) {
          let attempt = 0;
          while (attempt < retries) {
            try {
              if (!client) {
                // If no client, fetch token and create
                const resp = await fetch('/api/create_sat', { method: 'POST' });
                const data = await resp.json();
                if (!data.token) throw new Error('Failed to get token');
                token = data.token;
                document.getElementById('token').value = token;
                await createClientAndAttachListeners(host, token);
              }
              await client.online({ incomingCallHandlers: { all: handleIncomingCall } });
              return true;
            } catch (err) {
              // If token error, fetch a new token and retry once
              if (!triedNewToken && (err.message?.includes('token') || err.message?.includes('401'))) {
                triedNewToken = true;
                const resp = await fetch('/api/create_sat', { method: 'POST' });
                const data = await resp.json();
                if (!data.token) throw new Error('Failed to get token');
                token = data.token;
                document.getElementById('token').value = token;
                await createClientAndAttachListeners(host, token);
                continue;
              }
              await new Promise(res => setTimeout(res, delay));
              attempt++;
            }
          }
          return false;
        }
        onlineSuccess = await tryOnlineWithRetry();
        if (onlineSuccess) {
          setDashboardStatus('online');
          goOfflineBtn.classList.remove('hidden');
          goOnlineBtn.classList.add('hidden');
        } else {
          setDashboardStatus('failed');
          goOnlineBtn.disabled = false;
          goOnlineBtn.classList.remove('hidden');
        }
      };

      function handleIncomingCall(notification) {
        invite = notification.invite;
        const call_id = invite.details.callID;
        let callerIdName = invite.details.caller_id_name;
        let callerIdNumber = invite.details.caller_id_number;
        let mainCaller = (callerIdName && callerIdName !== '_undef_') ? callerIdName : (callerIdNumber && callerIdNumber !== '_undef_') ? callerIdNumber : 'Unknown Caller';
        document.getElementById('incomingCallerName').textContent = mainCaller;
        document.getElementById('incomingCallerSummary').textContent = '';
        showModal('incomingCallModal');
        hangupCallBtn.classList.add('hidden');
        callAccepted = false;
        clearCallInfo(); // Hide dashboard info until accepted
        setDashboardStatus('incoming');
      }

      async function handleRejectCall() {
        if (invite) {
          try { await invite.reject(); } catch (e) { console.error('Failed to reject call:', e); }
        }
        hideModal('incomingCallModal');
        callAccepted = false;
        clearCallInfo();
      }
      modalRejectCallBtn.onclick = handleRejectCall;

      function setStatus(state) {
        const dot = document.getElementById('statusDot');
        const text = document.getElementById('statusText');
        dot.className = 'status-dot';
        switch(state) {
          case 'connecting': dot.classList.add('status-connecting'); text.textContent = 'Connecting'; break;
          case 'online': dot.classList.add('status-online'); text.textContent = 'Online'; break;
          case 'in-call': dot.classList.add('status-in-call'); text.textContent = 'In Call'; break;
          default: dot.classList.add('status-offline'); text.textContent = 'Offline';
        }
      }
      setStatus('offline');
      setDashboardStatus('offline');
      document.getElementById('showSubscriberInfo').onclick = function(e) {
        e.preventDefault();
        showModal('subscriberInfoModal');
      };

      modalAcceptCallBtn.onclick = async () => {
        if (!invite) return;
        try {
          call = await invite.accept({ audio: true, video: false });
          setDashboardStatus('in-call');
          hangupCallBtn.classList.remove('hidden');
          hangupCallBtn.disabled = false;
          callAccepted = true;
          applyCallInfoToUI(cachedCallInfo); // Now show call info in dashboard
          hideModal('incomingCallModal');
          call.on('destroy', resetAfterCallEnd);
        } catch (e) {
          alert('Failed to accept call: ' + e.message);
        }
      };

      // Wire up hangup button
      hangupCallBtn.onclick = async () => {
        if (call && typeof call.hangup === 'function') {
          try { await call.hangup(); } catch (err) {}
        }
        resetAfterCallEnd();
      };

      // Go Offline logic
      goOfflineBtn.onclick = async () => {
        if (client && typeof client.offline === 'function') {
          await client.offline();
        }
        setDashboardStatus('offline');
        goOfflineBtn.classList.add('hidden');
        goOnlineBtn.classList.remove('hidden');
        goOnlineBtn.disabled = false;
      };

      window.addEventListener('beforeunload', function () {
        if (call && typeof call.hangup === 'function') { try { call.hangup(); } catch (err) {} }
        if (client && typeof client.disconnect === 'function') { try { client.disconnect(); } catch (err) {} }
      });
    </script>
</body>
</html> 