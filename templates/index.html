<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Simple Server Home</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="/static/css/styles.css">
</head>
<body>
    <!-- SignalWire Navbar -->
    <header class="navbar navbar-dark sw-glass border-bottom py-3 mb-4">
        <div class="container">
            <a class="navbar-brand" href="https://signalwire.com" target="_blank">
                <span class="sw-logo" title="SignalWire Logo" aria-label="SignalWire Logo"></span>
            </a>
            <div>
                <a class="text-white text-decoration-none me-3" href="/">Home</a>
                <a class="text-white text-decoration-none me-3" href="/login">Subscriber login</a>
                <a class="text-white text-decoration-none me-3" href="https://developer.signalwire.com" target="_blank">Documentation</a>
                <a class="text-white text-decoration-none" href="https://github.com/signalwire" target="_blank">GitHub</a>
            </div>
        </div>
    </header>
    <div class="container py-5">
        <h1 class="sw-gradient-text mb-4">Welcome to the Simple Server!</h1>
        <p class="lead">This is the homepage served by Express.</p>
        <button id="callButton" class="demo-button-disabled">Call Now</button>
        <c2c-widget
            callDetails='{"destination": "/public/livewire", "supportsVideo": false, "supportsAudio": true}'
            collectUserDetails="false"
            userVariables='{"test": "john.doe@example.com"}'
            buttonId="callButton"
        ></c2c-widget>
    </div>
    <script>
        async function init() {
            const widget = document.querySelector("c2c-widget");
            const token = await getWidgetToken();
            widget.setAttribute("token", token);
            console.log(widget);

            widget.addEventListener("beforecall", async () => {
                console.log("beforecall");
            });

            widget.addEventListener("call.joined", ({ detail }) => {
                const client = detail.client;
                client.on("user_event", (params) => {
                    handleUserEvents(params);
                });
                console.log("call.joined", detail);
            });

            widget.addEventListener("call.left", ({ detail }) => {
                console.log("call.left", detail);
            });
        }

        async function getWidgetToken() {
            const response = await fetch("/api/get_embed_token", {
                method: "GET",
                headers: {
                    "Content-Type": "application/json"
                },
            });

            if (!response.ok) {
                throw new Error("Failed to authenticate embeds token", response.status);
            }

            const data = await response.json();
            return data.token;
        }

        async function handleUserEvents(params) {
            switch (params.type) {
                case "send_user_info":
                    console.log("send_user_info", params);
                    break;
            }
        }
        init();
    </script>
    <script src="https://cdn.jsdelivr.net/npm/@niravcodes/call-widget@latest/dist/c2c-widget-full.umd.min.js"></script>
</body>
</html>