<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Agent Dashboard</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="/static/css/styles.css">
    <link rel="stylesheet" href="/static/css/pages/agent_dashboard.css">
    <script src="https://cdn.signalwire.com/@signalwire/js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css">
</head>
<body>
    <!-- Topbar -->
    <header class="topbar d-flex align-items-center justify-content-between px-4">
      <div class="d-flex align-items-center">
        <span class="sw-logo"></span>
        <div class="agent-avatar">
          {{
            (subscriber_info.subscriber.first_name[0] if subscriber_info.subscriber.first_name else
             subscriber_info.subscriber.email[0] if subscriber_info.subscriber.email else
             'SW')
          }}
        </div>
        <div>
          <div class="fw-bold">{{ subscriber_info.subscriber.first_name }} {{ subscriber_info.subscriber.last_name }}</div>
          <div class="agent-email small">{{ subscriber_info.subscriber.email }}</div>
        </div>
      </div>
      <div class="d-flex align-items-center">
        <div id="agentStatus" class="agent-status">
          <span id="statusDot" class="status-dot status-offline"></span>
          <span id="statusText">Offline</span>
        </div>
        <div class="topbar-actions ms-4 dropdown">
          <a href="#" class="dropdown-toggle" id="settingsDropdown" data-bs-toggle="dropdown" aria-expanded="false" title="Settings">
            <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" fill="currentColor" class="bi bi-gear" viewBox="0 0 16 16"><path d="M8 4.754a3.246 3.246 0 1 0 0 6.492 3.246 3.246 0 0 0 0-6.492zM5.754 8a2.246 2.246 0 1 1 4.492 0 2.246 2.246 0 0 1-4.492 0z"/><path d="M9.796 1.343c-.527-1.79-3.065-1.79-3.592 0l-.094.319a.873.873 0 0 1-1.255.52l-.292-.16c-1.64-.892-3.433.902-2.54 2.541l.159.292a.873.873 0 0 1-.52 1.255l-.319.094c-1.79.527-1.79 3.065 0 3.592l.319.094a.873.873 0 0 1 .52 1.255l-.16.292c-.892 1.64.901 3.434 2.541 2.54l.292-.159a.873.873 0 0 1 1.255.52l.094.319c.527 1.79 3.065 1.79 3.592 0l.094-.319a.873.873 0 0 1 1.255-.52l.292.16c1.64.893 3.434-.902 2.54-2.541l-.159-.292a.873.873 0 0 1 .52-1.255l.319-.094c1.79-.527 1.79-3.065 0-3.592l-.319-.094a.873.873 0 0 1-.52-1.255l.16-.292c.893-1.64-.902-3.433-2.541-2.54l-.292.159a.873.873 0 0 1-1.255-.52l-.094-.319zm-2.633.283c.246-.835 1.428-.835 1.674 0l.094.319a1.873 1.873 0 0 0 2.693 1.115l.291-.16c.764-.415 1.6.42 1.184 1.185l-.159.292a1.873 1.873 0 0 0 1.116 2.692l.318.094c.835.246.835 1.428 0 1.674l-.319.094a1.873 1.873 0 0 0-1.115 2.693l.16.291c.415.764-.42 1.6-1.185 1.184l-.291-.159a1.873 1.873 0 0 0-2.693 1.116l-.094.318c-.246.835-1.428.835-1.674 0l-.094-.319a1.873 1.873 0 0 0-2.692-1.115l-.292.16c-.764.415-1.6-.42-1.184-1.185l.159-.291A1.873 1.873 0 0 0 1.945 8.93l-.319-.094c-.835-.246-.835-1.428 0-1.674l.319-.094A1.873 1.873 0 0 0 3.38 4.377l-.16-.292c-.415-.764.42-1.6 1.185-1.184l.292.159a1.873 1.873 0 0 0 2.692-1.115l.094-.319z"/></svg>
          </a>
          <ul class="dropdown-menu" aria-labelledby="settingsDropdown">
            <li><a class="dropdown-item" href="#" id="showSubscriberInfo">Subscriber Info</a></li>
            <li><hr class="dropdown-divider"></li>
            <li><a class="dropdown-item" href="/logout">Logout</a></li>
          </ul>
        </div>
      </div>
    </header>
    <div class="container">
      <div class="row justify-content-center">
        <div class="col-lg-8">
          <div class="dashboard-card main-controls">
            <div class="d-flex flex-column align-items-center mb-3">
              <div id="callStatus" class="mb-2">Waiting for call...</div>
            </div>
            <div id="callInfo" class="mb-3"></div>
            <div class="call-controls">
              <button id="goOnlineBtn" class="demo-button">Go Online</button>
              <button id="btnDisconnect" class="demo-button hidden">Disconnect</button>
              <button id="acceptCallBtn" class="demo-button hidden">Accept Call</button>
              <button id="rejectCallBtn" class="demo-button hidden">Reject Call</button>
              <button id="hangupCallBtn" class="demo-button hidden">Hangup</button>
            </div>
          </div>
        </div>
      </div>
    </div>
    <input id="host" type="hidden" value="devspace.signalwire.com" />
    <input id="token" type="hidden" value="" readonly />
    <!-- Subscriber Info Modal -->
    <div class="modal fade" id="subscriberInfoModal" tabindex="-1" aria-labelledby="subscriberInfoModalLabel" aria-hidden="true">
      <div class="modal-dialog">
        <div class="modal-content bg-dark text-white border-0">
          <div class="modal-header border-0" style="background:rgba(12,19,57,0.95);">
            <h5 class="modal-title" id="subscriberInfoModalLabel">Subscriber Info</h5>
            <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
          </div>
          <div class="modal-body" style="background:rgba(12,19,57,0.85);">
            <table class="table table-dark table-borderless mb-0">
              <tr><th>Email:</th><td>{{ subscriber_info.subscriber.email }}</td></tr>
              <tr><th>First Name:</th><td>{{ subscriber_info.subscriber.first_name }}</td></tr>
              <tr><th>Last Name:</th><td>{{ subscriber_info.subscriber.last_name }}</td></tr>
              <tr><th>Display Name:</th><td>{{ subscriber_info.subscriber.display_name }}</td></tr>
              <tr><th>Subscriber ID:</th><td>{{ subscriber_info.subscriber.id }}</td></tr>
            </table>
          </div>
          <div class="modal-footer border-0" style="background:rgba(12,19,57,0.95);">
            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
          </div>
        </div>
      </div>
    </div>
    <!-- Incoming Call Modal -->
    <div class="modal fade" id="incomingCallModal" tabindex="-1" aria-labelledby="incomingCallModalLabel" aria-hidden="true">
      <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content bg-dark text-white border-0" style="box-shadow: 0 8px 32px rgba(0,0,0,0.35);">
          <div class="modal-header border-0" style="background:rgba(12,19,57,0.95);">
            <h5 class="modal-title" id="incomingCallModalLabel">
              <i class="bi bi-telephone-inbound me-2" style="font-size: 1.5em;"></i>
              Incoming Call
            </h5>
            <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
          </div>
          <div class="modal-body text-center" style="background:rgba(12,19,57,0.85);">
            <div id="incomingCallerName" class="fs-4 fw-bold mb-2"></div>
            <div id="incomingCallerSummary" class="mb-3 text-secondary"></div>
            <div class="d-flex justify-content-center gap-4 mt-4">
              <button id="modalAcceptCallBtn" class="btn btn-success btn-lg rounded-circle d-flex align-items-center justify-content-center" style="width:64px;height:64px;">
                <i class="bi bi-telephone" style="font-size:2em;"></i>
              </button>
              <button id="modalRejectCallBtn" class="btn btn-danger btn-lg rounded-circle d-flex align-items-center justify-content-center" style="width:64px;height:64px;">
                <i class="bi bi-telephone-x" style="font-size:2em;"></i>
              </button>
            </div>
          </div>
        </div>
      </div>
    </div>
    <script>
      let client = null;
      let invite = null;
      let call = null;
      let currentCallId = null;

      const btnConnect = document.getElementById('btnConnect');
      const btnDisconnect = document.getElementById('btnDisconnect');
      const acceptCallBtn = document.getElementById('acceptCallBtn');
      const rejectCallBtn = document.getElementById('rejectCallBtn');
      const callStatus = document.getElementById('callStatus');
      const hangupCallBtn = document.getElementById('hangupCallBtn');
      const callInfoDiv = document.getElementById('callInfo');
      const goOnlineBtn = document.getElementById('goOnlineBtn');
      const tokenInput = document.getElementById('token');

      // Enable Connect only after token is fetched
      function enableConnect(enable) {
        document.getElementById('btnConnect').disabled = !enable;
      }

      goOnlineBtn.onclick = async () => {
        setStatus('connecting');
        goOnlineBtn.disabled = true;
        // Hide Go Online, show nothing until connected
        goOnlineBtn.classList.add('hidden');
        btnDisconnect.classList.add('hidden');
        callStatus.textContent = 'Connecting...';
        try {
          callStatus.textContent = 'Getting token...';
          const resp = await fetch('/api/create_sat', { method: 'POST' });
          const data = await resp.json();
          if (data.token) {
            document.getElementById('token').value = data.token;
            callStatus.textContent = 'Connecting...';
            await new Promise(resolve => setTimeout(resolve, 1000)); // 1 second delay
            // Now connect
            const host = document.getElementById('host').value;
            const token = data.token;
            if (!host || !token) {
              alert('Please enter host and token.');
              goOnlineBtn.disabled = false;
              goOnlineBtn.classList.remove('hidden');
              return;
            }
            try {
              client = await SignalWire.SignalWire({
                host,
                token,
                debug: { logWsTraffic: false },
              });
              window.__client = client;
              // Show Disconnect, hide Go Online
              goOnlineBtn.classList.add('hidden');
              btnDisconnect.classList.remove('hidden');

              // Retry logic for client.online
              async function tryOnlineWithRetry(retries = 20, delay = 300) {
                let attempt = 0;
                while (attempt < retries) {
                  try {
                    await client.online({
                      incomingCallHandlers: { all: handleIncomingCall },
                    });
                    return true;
                  } catch (err) {
                    if (err && err.code === -32603 && err.message && err.message.includes('WebRTC endpoint registration failed')) {
                      // Suppress error log for this case
                      await new Promise(res => setTimeout(res, delay));
                      attempt++;
                      continue;
                    } else {
                      // Log and show other errors
                      callStatus.textContent = 'Failed to connect: ' + (err.message || err);
                      console.error('Failed to connect:', err);
                      alert('Failed to connect: ' + (err.message || err));
                      goOnlineBtn.disabled = false;
                      goOnlineBtn.classList.remove('hidden');
                      return false;
                    }
                  }
                }
                callStatus.textContent = 'Failed to connect after multiple retries.';
                alert('Failed to connect after multiple retries.');
                goOnlineBtn.disabled = false;
                goOnlineBtn.classList.remove('hidden');
                return false;
              }

              const onlineSuccess = await tryOnlineWithRetry();
              if (onlineSuccess) {
                setStatus('online');
                callStatus.textContent = 'Connected. Waiting for call...';
              }

              client.on('call.state', (params) => {
                console.log('call.state', params);
                if (params.call_state === 'created' && params.parent && params.parent.call_id) {
                  const infoKey = params.parent.call_id;
                  fetch(`/api/call_info/${infoKey}`)
                    .then(resp => resp.ok ? resp.json() : null)
                    .then(data => {
                      if (data && !data.error) {
                        callInfoDiv.innerHTML = `<b>Caller:</b> ${data.first_name || ''} ${data.last_name || ''}<br><b>Summary:</b> ${data.summary || ''}`;
                      } else {
                        callInfoDiv.innerHTML = '<i>No call info found for this call.</i>';
                      }
                    })
                    .catch(() => {
                      callInfoDiv.innerHTML = '<i>Error fetching call info.</i>';
                    });
                }
              });
            } catch (e) {
              console.error('Failed to connect:', e);
              alert('Failed to connect: ' + e.message);
              goOnlineBtn.disabled = false;
              goOnlineBtn.classList.remove('hidden');
            }
          } else {
            alert('Failed to get token: ' + (data.error || 'Unknown error'));
            goOnlineBtn.disabled = false;
            goOnlineBtn.classList.remove('hidden');
          }
        } catch (e) {
          alert('Error: ' + e.message);
          goOnlineBtn.disabled = false;
          goOnlineBtn.classList.remove('hidden');
        }
      };

      btnDisconnect.onclick = async () => {
        if (client) {
          await client.disconnect();
        }
        // Reset to initial state
        goOnlineBtn.classList.remove('hidden');
        goOnlineBtn.disabled = false;
        btnDisconnect.classList.add('hidden');
        callStatus.textContent = 'Disconnected.';
        setStatus('offline');
        acceptCallBtn.classList.add('hidden');
        rejectCallBtn.classList.add('hidden');
        hangupCallBtn.classList.add('hidden');
        callInfoDiv.innerHTML = '';
      };

      function handleIncomingCall(notification) {
        console.log('handleIncomingCall', notification);
        invite = notification.invite;
        const call_id = invite.details.callID;
        console.log('call_id', call_id);
        currentCallId = call_id;
        // Get caller name from invite.details.caller_id_name or caller_id_number
        let callerIdName = invite.details.caller_id_name;
        let callerIdNumber = invite.details.caller_id_number;
        let mainCaller = (callerIdName && callerIdName !== '_undef_')
          ? callerIdName
          : (callerIdNumber && callerIdNumber !== '_undef_')
            ? callerIdNumber
            : 'Unknown Caller';
        document.getElementById('incomingCallerName').textContent = mainCaller;
        document.getElementById('incomingCallerSummary').textContent = '';
        var modal = new bootstrap.Modal(document.getElementById('incomingCallModal'));
        modal.show();
        // Hide Accept/Reject in dashboard, only show in modal
        acceptCallBtn.classList.add('hidden');
        rejectCallBtn.classList.add('hidden');
        hangupCallBtn.classList.add('hidden');
        acceptCallBtn.disabled = false;
        rejectCallBtn.disabled = false;
        callInfoDiv.innerHTML = '';
        // Listen for call.state to update modal with info and to auto-close modal if missed
        if (client) {
          client.on('call.state', (params) => {
            // Update modal with fetched info
            if (params.call_state === 'created' && params.parent && params.parent.call_id) {
              fetch(`/api/call_info/${params.parent.call_id}`)
                .then(resp => resp.ok ? resp.json() : null)
                .then(data => {
                  if (data && !data.error && (data.first_name || data.last_name || data.summary)) {
                    let details = '';
                    if (data.first_name || data.last_name) {
                      details += `<b>Name:</b> ${[data.first_name, data.last_name].filter(Boolean).join(' ')}<br>`;
                    }
                    if (data.summary) {
                      details += `<b>Summary:</b> ${data.summary}`;
                    }
                    document.getElementById('incomingCallerSummary').innerHTML = details;
                  } else {
                    document.getElementById('incomingCallerSummary').innerHTML = '';
                  }
                })
                .catch(() => {
                  document.getElementById('incomingCallerSummary').innerHTML = '';
                });
            }
            // Auto-close modal if call ended
            if (params.call_id === call_id && params.call_state === 'ended') {
              const modalEl = document.getElementById('incomingCallModal');
              if (modalEl.classList.contains('show')) {
                modalEl.classList.remove('show');
                modalEl.style.display = 'none';
                document.body.classList.remove('modal-open');
                document.querySelector('.modal-backdrop')?.remove();
              }
            }
          });
        }
      }

      // Modal Accept/Reject handlers
      document.getElementById('modalAcceptCallBtn').onclick = async () => {
        // Hide modal
        document.getElementById('incomingCallModal').classList.remove('show');
        document.getElementById('incomingCallModal').style.display = 'none';
        document.body.classList.remove('modal-open');
        document.querySelector('.modal-backdrop')?.remove();
        // Show summary in dashboard after accepting
        await acceptCallBtn.onclick();
      };
      document.getElementById('modalRejectCallBtn').onclick = async () => {
        document.getElementById('incomingCallModal').classList.remove('show');
        document.getElementById('incomingCallModal').style.display = 'none';
        document.body.classList.remove('modal-open');
        document.querySelector('.modal-backdrop')?.remove();
        await rejectCallBtn.onclick();
      };

      // Remove statusTextMain and only update navbar indicator
      function setStatus(state) {
        const dot = document.getElementById('statusDot');
        const text = document.getElementById('statusText');
        dot.className = 'status-dot';
        switch(state) {
          case 'connecting':
            dot.classList.add('status-connecting');
            text.textContent = 'Connecting';
            break;
          case 'online':
            dot.classList.add('status-online');
            text.textContent = 'Online';
            break;
          case 'in-call':
            dot.classList.add('status-in-call');
            text.textContent = 'In Call';
            break;
          default:
            dot.classList.add('status-offline');
            text.textContent = 'Offline';
        }
      }
      // Set initial status and call area message
      setStatus('offline');
      callStatus.textContent = 'Go online to receive calls.';
      // Show subscriber info modal
      document.getElementById('showSubscriberInfo').onclick = function(e) {
        e.preventDefault();
        var modal = new bootstrap.Modal(document.getElementById('subscriberInfoModal'));
        modal.show();
      };

      acceptCallBtn.onclick = async () => {
        if (!invite) return;
        console.log('Attempting to accept call...');
        try {
          call = await invite.accept({
            audio: true,
            video: false
          });
          console.log('Call accepted:', call);
          callStatus.textContent = 'In call!';
          setStatus('in-call');
          // Show only Hangup
          acceptCallBtn.classList.add('hidden');
          rejectCallBtn.classList.add('hidden');
          hangupCallBtn.classList.remove('hidden');
          hangupCallBtn.disabled = false;
          // Show summary in dashboard after accepting
          // (fetch again in case info changed)
          fetch(`/api/call_info/${currentCallId}`)
            .then(resp => resp.ok ? resp.json() : null)
            .then(data => {
              if (data && !data.error) {
                callInfoDiv.innerHTML = `<b>Caller:</b> ${data.first_name || ''} ${data.last_name || ''}<br><b>Summary:</b> ${data.summary || ''}`;
              } else {
                callInfoDiv.innerHTML = '<i>No call info found for this call.</i>';
              }
            })
            .catch(() => {
              callInfoDiv.innerHTML = '<i>Error fetching call info.</i>';
            });
          call.on('destroy', () => {
            callStatus.textContent = 'Call ended.';
            setStatus('online');
            // Hide all call control buttons
            hangupCallBtn.classList.add('hidden');
            acceptCallBtn.classList.add('hidden');
            rejectCallBtn.classList.add('hidden');
            callInfoDiv.innerHTML = '';
            // Optionally, show Disconnect again
            btnDisconnect.classList.remove('hidden');
          });
        } catch (e) {
          console.error('Failed to accept call:', e);
          alert('Failed to accept call: ' + e.message);
        }
      };
    </script>
</body>
</html> 